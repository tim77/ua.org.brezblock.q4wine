id: ua.org.brezblock.q4wine.wine.staging
runtime: ua.org.brezblock.q4wine
runtime-version: stable
sdk: org.kde.Sdk//5.11
build-extension: true
separate-locales: false
appstream-compose: false
build-options:
    prefix: /app/wine/staging
    env:
      PATH: /app/wine/staging/bin:/app/bin:/usr/bin
    strip: true
    no-debuginfo: false
cleanup:
  - /include
  - /share/man
  - /share/applications
modules:
  - name: wine
    build-options:
      arch:
        x86_64:
          config-opts:
            - --enable-win64
    config-opts:
      - --disable-win16
      - --disable-tests
      - --with-x
      - --without-ldap
      - --without-cups
      - --without-curses
      - --without-capi
      - --without-glu
      - --without-gphoto
      - --without-gsm
      - --without-hal
      - --without-netapi
      - --without-opencl
      - --without-pcap
      - --without-udev
      - --without-v4l
    post-install:
      - case $FLATPAK_ARCH in
          x86_64)
            mv $FLATPAK_DEST/bin/wineserver{,64}
          ;;
          i386)
            mv $FLATPAK_DEST/bin/wineserver{,32}
          ;;
        esac
    cleanup:
      - /share/man
      - /share/applications
    sources:
      - type: archive
        url: "https://dl.winehq.org/wine/source/3.x/wine-3.20.tar.xz"
        sha256: 33d61122085056e091042df7d2cbe908ffb9c06e602278611dca2eea6a566f18
      - type: archive
        url: "https://github.com/wine-staging/wine-staging/archive/v3.20.tar.gz"
        sha256: 796e6dec0091aa8c22fb1adf3f4bd2b6122b5aac9ae90daffd2e4a4326d0115b
        dest: staging
      - type: shell
        commands:
          - ./staging/patches/patchinstall.sh DESTDIR="$(pwd)" --all

  - name: wineserver
    buildsystem: simple
    build-commands:
      - install -Dm755 wineserver.sh $FLATPAK_DEST/bin/wineserver
    sources:
      - type: script
        dest-filename: wineserver.sh
        commands:
          - winedir=/app/wine/staging
          # 64bit mode
          - if test -x $winedir/bin/wineserver64; then
          -   exec $winedir/bin/wineserver64 $@
          # Pure 32bit mode
          - elif test -x $winedir/bin/wineserver32; then
          -   exec $winedir/bin/wineserver32 $@
          - else
          -   exit 1
          - fi

  - name: compat32
    only-arches:
      - x86_64
    buildsystem: simple
    build-commands:
      - mkdir -p $FLATPAK_DEST/32bit
      - ln -s 32bit/lib $FLATPAK_DEST/lib
      - ln -s ../32bit/bin/wine $FLATPAK_DEST/bin/wine
      - ln -s ../32bit/bin/wine-preloader $FLATPAK_DEST/bin/wine-preloader

  - name: appdata
    buildsystem: simple
    build-commands:
      - install -Dm644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - appstream-compose --basename=${FLATPAK_ID} --prefix=${FLATPAK_DEST} --origin=flatpak ${FLATPAK_ID}
    sources:
      - type: file
        path: ua.org.brezblock.q4wine.wine.staging.metainfo.xml
